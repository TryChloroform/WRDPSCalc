<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weapon TTK Calculator</title>
    <style>
        /* --- FONT DEFINITIONS --- */
        /* Ensure you have these font files or update the URLs to your CDN/Local path */
        @font-face {
            font-family: 'Reckoner Bold';
            src: url('fonts/Reckoner_Bold.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
        }

        @font-face {
            font-family: 'Google Sans';
            src: url('fonts/GoogleSans-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Google Sans';
            src: url('fonts/GoogleSans-Bold.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            /* Fallback to Roboto/Arial if Google Sans is missing */
            font-family: 'Google Sans', 'Roboto', Arial, sans-serif;
            background: #f0f2f5;
            padding: 20px;
            color: #1c1e21;
        }

        /* --- TYPOGRAPHY OVERRIDES --- */
        h1, h2, h3, .ttk-value, .ttk-label, .weapon-number, .calculate-btn, .add-weapon-btn {
            /* Fallback to Impact/System if Reckoner is missing */
            font-family: 'Reckoner Bold', 'Impact', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Ensure inputs use the body font, not system default */
        input, select, button, textarea {
            font-family: 'Google Sans', 'Roboto', Arial, sans-serif;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        h1 {
            margin-bottom: 25px;
            color: #1a1a1a;
            font-size: 32px;
            font-weight: normal; /* Let the font file handle weight */
        }

        /* --- Input Sections --- */
        .config-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            margin-bottom: 20px;
        }

        .config-section h3 {
            margin-bottom: 15px;
            font-size: 20px;
            color: #495057;
        }

        .config-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        .config-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .config-item input[type="text"],
        .config-item input[type="number"],
        .config-item select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .config-item input:focus,
        .config-item select:focus {
            border-color: #007bff;
            outline: none;
        }
        
        .value-display {
            float: right;
            background: #343a40;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-family: 'Google Sans', sans-serif; /* Keep numbers readable */
        }

        /* --- Weapons List --- */
        .weapon-item {
            display: grid;
            grid-template-columns: 32px 1fr 1fr 1fr 1fr 32px;
            gap: 12px;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .weapon-number {
            width: 28px;
            height: 28px;
            background: #495057;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            padding-top: 2px; /* Visual adjustment for Reckoner */
        }

        .add-weapon-btn {
            width: 100%;
            padding: 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 25px;
            transition: background 0.2s;
        }
        .add-weapon-btn:hover { background: #218838; }
        .add-weapon-btn:disabled { background: #e9ecef; color: #adb5bd; cursor: default; }

        .remove-btn {
            background: #ff4d4f;
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: Arial, sans-serif; /* Keep X symbol standard */
        }

        /* --- Action --- */
        .calculate-btn {
            width: 100%;
            padding: 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,123,255,0.2);
            transition: transform 0.1s;
        }
        .calculate-btn:hover { background: #0056b3; }
        .calculate-btn:active { transform: scale(0.99); }

        /* --- Results --- */
        .results {
            margin-top: 30px;
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .results.show { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .ttk-box {
            background: #e7f5ff;
            color: #004085;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 25px;
            border: 1px solid #b8daff;
        }
        
        .ttk-value { 
            font-size: 56px; 
            line-height: 1.1;
        }
        .ttk-label { 
            font-size: 18px; 
            opacity: 0.8; 
        }

        table { width: 100%; border-collapse: collapse; margin-bottom: 25px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #dee2e6; }
        th { background: #f8f9fa; color: #495057; font-weight: 600; }
        
        /* --- Timeline --- */
        .timeline-section {
            padding: 20px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        .timeline-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>

<body>
    <div class="container">
        <h1>TTK Calculator</h1>

        <div id="weaponsContainer" class="weapons-list"></div>
        <button class="add-weapon-btn" id="addWeaponBtn" onclick="addWeapon()">+ Add Weapon</button>

        <div class="config-section">
            <h3>Target Configuration</h3>
            
            <div class="config-row">
                <div class="config-item">
                    <label>Enemy Health <span class="value-display" id="healthDisplay">300,000</span></label>
                    <input type="range" id="healthSlider" min="0" max="100" value="50" step="0.1" style="width:100%">
                    <input type="number" id="healthInput" value="300000" style="margin-top: 5px;">
                </div>
                
                <div class="config-item">
                    <label>Defence Points <span class="value-display" id="defenceDisplay">0</span></label>
                    <input type="range" id="defenceSlider" min="0" max="900" value="0" step="1" style="width:100%">
                    <input type="number" id="defenceInput" value="0" style="margin-top: 5px;">
                </div>
            </div>
        </div>

        <div class="config-section">
            <h3>Healing Configuration</h3>
            
            <div class="config-row">
                <div class="config-item">
                    <label>Active Module</label>
                    <select id="healingModule">
                        <option value="none">None</option>
                        <option value="repair">Repair Unit (5%/s, 5s)</option>
                        <option value="advanced">Advanced Repair Unit (10%/s, 4s)</option>
                    </select>
                </div>
                
                <div class="config-item">
                    <label>Activation Thresholds (%)</label>
                    <input type="text" id="healThresholds" placeholder="e.g. 50, 25">
                    <small style="color: #6c757d; font-size: 11px; display: block; margin-top: 4px;">
                        Module activates when health drops below these % values (if off cooldown).
                    </small>
                </div>
            </div>
        </div>

        <button class="calculate-btn" onclick="handleCalculateTTK()">Calculate Time to Kill</button>

        <div class="results" id="results">
            <div class="ttk-box">
                <div class="ttk-label">Time to Kill</div>
                <div class="ttk-value" id="ttkValue">0.00s</div>
            </div>

            <table>
                <thead>
                    <tr><th>Metric</th><th>Value</th></tr>
                </thead>
                <tbody>
                    <tr><td>Total Shots Fired</td><td id="totalShots">0</td></tr>
                    <tr><td>Total Damage Dealt</td><td id="totalDamage">0</td></tr>
                    <tr><td>Damage Mitigated (Defence)</td><td id="damageMitigated">0</td></tr>
                    <tr><td>Combined DPS</td><td id="combinedDPS">0</td></tr>
                </tbody>
            </table>

            <h3 style="margin-bottom:15px; color:#495057;">Weapon Breakdown</h3>
            <table id="weaponBreakdown">
                <thead>
                    <tr>
                        <th>Weapon</th>
                        <th>Shots</th>
                        <th>Damage</th>
                        <th>Reloads</th>
                    </tr>
                </thead>
                <tbody id="breakdownBody"></tbody>
            </table>

            <div class="timeline-section">
                <div class="timeline-header">
                    <h3>Simulation Timeline</h3>
                    <button id="expandBtn" onclick="toggleFullscreen()" style="padding:6px 12px; cursor:pointer;">Expand</button>
                </div>
                <div id="timelineContainer" style="position:relative; width:100%;">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // --- UI Logic from original file, kept mostly intact but streamlined ---
        let weaponCount = 0;
        const MAX_WEAPONS = 6;
        let timelineChart = null;
        const slotOrder = { "Light": 1, "Medium": 2, "Heavy": 3, "Beta": 4, "Alpha": 5 };
        
        // --- Slider Logic ---
        const MIN_HEALTH = 50000, MAX_HEALTH = 20000000, MID_HEALTH = 300000;

        function sliderToHealth(val) {
            const pos = val / 100;
            if (pos <= 0.5) return MIN_HEALTH + (MID_HEALTH - MIN_HEALTH) * (pos * 2);
            const t = (pos - 0.5) * 2;
            return MID_HEALTH + (MAX_HEALTH - MID_HEALTH) * Math.pow(t, 2.5);
        }

        function healthToSlider(h) {
            if (h <= MID_HEALTH) return ((h - MIN_HEALTH) / (MID_HEALTH - MIN_HEALTH)) * 50;
            return 50 + Math.pow((h - MID_HEALTH) / (MAX_HEALTH - MID_HEALTH), 1/2.5) * 50;
        }

        function formatNumber(v) { return v ? v.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : "0"; }

        // Event Listeners
        document.getElementById('healthSlider').addEventListener('input', function() {
            const h = Math.round(sliderToHealth(this.value));
            document.getElementById('healthDisplay').textContent = formatNumber(h);
            document.getElementById('healthInput').value = h;
        });
        
        document.getElementById('healthInput').addEventListener('input', function() {
            let v = parseInt(this.value) || MIN_HEALTH;
            this.value = v; // auto correct? maybe not for UX, but kept simple
            document.getElementById('healthSlider').value = healthToSlider(v);
            document.getElementById('healthDisplay').textContent = formatNumber(v);
        });

        document.getElementById('defenceSlider').addEventListener('input', function() {
            document.getElementById('defenceInput').value = this.value;
            document.getElementById('defenceDisplay').textContent = this.value;
        });

        document.getElementById('defenceInput').addEventListener('input', function() {
            let v = Math.min(900, Math.max(0, parseInt(this.value)||0));
            document.getElementById('defenceSlider').value = v;
            document.getElementById('defenceDisplay').textContent = v;
        });

        // --- Config Getters ---
        function getHealingConfig() {
            const moduleKey = document.getElementById("healingModule").value;
            const thresholdStr = document.getElementById("healThresholds").value;
            
            // Parse comma separated thresholds: "50, 20" -> [50, 20]
            const thresholds = thresholdStr.split(",")
                .map(s => parseFloat(s.trim()))
                .filter(n => !isNaN(n) && n > 0 && n <= 100);

            // Default to 40% if repair selected but no threshold entered
            if (moduleKey !== 'none' && thresholds.length === 0) {
                thresholds.push(40);
            }

            const config = { ...HEALING_MODULES[moduleKey] };
            config.thresholds = thresholds;
            return config;
        }

        // --- Main Calculation Handler ---
        function handleCalculateTTK() {
            // 1. Gather Weapons
            const weaponItems = document.querySelectorAll('.weapon-item');
            if (weaponItems.length === 0) return alert('Please add at least one weapon');

            const weapons = [];
            let valid = true;
            weaponItems.forEach(item => {
                const name = document.getElementById(`${item.id}_weapon`).value;
                const level = document.getElementById(`${item.id}_level`).value;
                if(!name || !level) valid = false;
                weapons.push({ name, level });
            });
            if(!valid) return alert('Please select weapon and level for all entries');

            // 2. Gather Stats
            const health = parseInt(document.getElementById('healthInput').value);
            const defence = parseInt(document.getElementById('defenceInput').value);
            const healing = getHealingConfig();

            // 3. Run Sim
            try {
                const result = calculateTTK(health, defence, weapons, healing);
                
                // 4. Update UI
                document.getElementById('ttkValue').textContent = result.ttk.toFixed(2) + 's';
                document.getElementById('totalShots').textContent = formatNumber(result.total_shots);
                document.getElementById('totalDamage').textContent = formatNumber(result.total_damage);
                document.getElementById('damageMitigated').textContent = formatNumber(result.damage_mitigated);
                document.getElementById('combinedDPS').textContent = formatNumber(result.dps);

                const tbody = document.getElementById('breakdownBody');
                tbody.innerHTML = '';
                result.breakdown.forEach(w => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${w.name}</td>
                            <td>${formatNumber(w.shots)}</td>
                            <td>${formatNumber(w.damage)}</td>
                            <td>${w.reloads}</td>
                        </tr>
                    `;
                });

                document.getElementById('results').classList.add('show');
                renderTimeline(result.timeline, health);

            } catch(e) {
                console.error(e);
                alert("Calculation error: " + e.message);
            }
        }

        // --- Chart.js Visualization ---
        function renderTimeline(timeline, maxStartHealth) {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            if(timelineChart) timelineChart.destroy();

            // Data Prep
            const healthPoints = timeline.enemyHealth.map(p => ({ x: p.time, y: p.health / maxStartHealth }));
            const maxHealthPoints = timeline.enemyHealth.map(p => ({ x: p.time, y: p.maxHealth / maxStartHealth }));
            
            // Healing Markers
            const healMarkers = timeline.healTimeline.map(h => ({ x: h.time, y: 0.05 })); // show near bottom

            // Weapon Ammo Lines (Simplified for readability)
            const weaponDatasets = [];
            const colors = ['#36A2EB', '#FF6384', '#FF9F40', '#4BC0C0', '#9966FF', '#FFCD56'];
            
            Object.keys(timeline.weapons).forEach((wName, idx) => {
                const points = timeline.weapons[wName];
                const wData = weaponsData[wName];
                const max = wData ? wData.clip_size : 100;
                
                // Downsample for performance if too many points
                const data = points.map(p => ({ x: p.time, y: p.ammo / max }));
                
                weaponDatasets.push({
                    label: wName,
                    data: data,
                    borderColor: colors[idx % colors.length],
                    borderWidth: 1,
                    pointRadius: 0,
                    yAxisID: 'y-ammo',
                    hidden: true // Hide weapons by default to keep chart clean
                });
            });

            timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Current HP',
                            data: healthPoints,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            fill: true,
                            borderWidth: 2,
                            pointRadius: 0,
                            yAxisID: 'y-health'
                        },
                        {
                            label: 'Max HP Cap (Grey Dmg)',
                            data: maxHealthPoints,
                            borderColor: '#6c757d',
                            borderDash: [5, 5],
                            borderWidth: 2,
                            pointRadius: 0,
                            yAxisID: 'y-health'
                        },
                        {
                            label: 'Heal Trigger',
                            data: healMarkers,
                            type: 'scatter',
                            backgroundColor: '#28a745',
                            pointStyle: 'triangle',
                            pointRadius: 8,
                            yAxisID: 'y-health'
                        },
                        ...weaponDatasets
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { type: 'linear', title: {display:true, text:'Time (s)'} },
                        'y-health': { 
                            type: 'linear', position: 'left', min: 0, max: 1.05,
                            title: {display:true, text:'Health Fraction'} 
                        },
                        'y-ammo': {
                            type: 'linear', position: 'right', min:0, max:1, display:false
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    if(ctx.dataset.label === 'Current HP') {
                                        return `HP: ${Math.round(ctx.raw.y * maxStartHealth).toLocaleString()}`;
                                    }
                                    return `${ctx.dataset.label}: ${(ctx.raw.y*100).toFixed(0)}%`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- Fullscreen Toggle ---
        function toggleFullscreen() {
            const el = document.getElementById('timelineContainer');
            el.classList.toggle('fs-mode');
            if(el.classList.contains('fs-mode')) {
                el.style.position = 'fixed'; el.style.inset = '0'; el.style.background='white'; el.style.zIndex='1000'; el.style.padding='40px';
                document.getElementById('expandBtn').textContent = 'Close';
            } else {
                el.style = 'position:relative; width:100%;';
                document.getElementById('expandBtn').textContent = 'Expand';
            }
        }

        // --- Setup Dynamic Selects (Copied helpers) ---
        function createSlotOptions() {
            const slots = new Set();
            Object.values(weaponsData).forEach(d => { if(d.slot) slots.add(d.slot); });
            return ['<option value="">-- Slot --</option>', ...Array.from(slots).sort((a,b)=>(slotOrder[a]||9)-(slotOrder[b]||9)).map(s=>`<option value="${s}">${s}</option>`)].join('');
        }
        function createTierOptions(slot) {
            const tiers = new Set();
            Object.values(weaponsData).filter(d => d.slot===slot).forEach(d => { if(d.tier) tiers.add(d.tier); });
            return ['<option value="">-- Tier --</option>', ...Array.from(tiers).sort().map(t=>`<option value="${t}">${t==='终极'?'Ultimate':t}</option>`)].join('');
        }
        function createWeaponOptions(slot, tier) {
            const names = Object.keys(weaponsData).filter(k => weaponsData[k].slot===slot && weaponsData[k].tier===tier).sort();
            return ['<option value="">-- Weapon --</option>', ...names.map(n=>`<option value="${n}">${n}</option>`)].join('');
        }
        function createLevelOptions(slot, wName) {
            const w = weaponsData[wName];
            if(!w) return '';
            const opts = [];
            for(let i=1; i<=25; i++) {
                if(w[`damage_${i}`]) {
                    let label = (slot==='Alpha'||slot==='Beta') ? `Lvl ${i}` : (i<=12?`MK1 Lv${i}`:(i<=24?`MK2 Lv${i-12}`:`MK3 Lv1`));
                    opts.push(`<option value="damage_${i}">${label}</option>`);
                }
            }
            return ['<option value="">-- Level --</option>', ...opts].join('');
        }

        // --- Dynamic Form Logic ---
        function addWeapon() {
            if(weaponCount >= MAX_WEAPONS) return;
            weaponCount++;
            const id = `weapon${weaponCount}`;
            const div = document.createElement('div');
            div.className = 'weapon-item';
            div.id = id;
            div.innerHTML = `
                <div class="weapon-number">${weaponCount}</div>
                <select id="${id}_slot" onchange="onSlotChange('${id}')">${createSlotOptions()}</select>
                <select id="${id}_tier" onchange="onTierChange('${id}')" disabled></select>
                <select id="${id}_weapon" onchange="onWeaponChange('${id}')" disabled></select>
                <select id="${id}_level" disabled></select>
                <button class="remove-btn" onclick="removeWeapon('${id}')">×</button>
            `;
            document.getElementById('weaponsContainer').appendChild(div);
            
            // Auto-fill from previous if exists
            if(weaponCount > 1) {
                const prevId = `weapon${weaponCount-1}`;
                const prevSlot = document.getElementById(`${prevId}_slot`).value;
                if(prevSlot) {
                    const sel = document.getElementById(`${id}_slot`);
                    sel.value = prevSlot;
                    sel.onchange(); 
                }
            }
        }
        
        function removeWeapon(id) {
            document.getElementById(id).remove();
            weaponCount--;
        }

        // Change Handlers
        window.onSlotChange = (id) => {
            const slot = document.getElementById(`${id}_slot`).value;
            const tSel = document.getElementById(`${id}_tier`);
            tSel.innerHTML = createTierOptions(slot);
            tSel.disabled = false;
            document.getElementById(`${id}_weapon`).innerHTML = ''; document.getElementById(`${id}_weapon`).disabled = true;
            document.getElementById(`${id}_level`).innerHTML = ''; document.getElementById(`${id}_level`).disabled = true;
        };
        window.onTierChange = (id) => {
            const slot = document.getElementById(`${id}_slot`).value;
            const tier = document.getElementById(`${id}_tier`).value;
            const wSel = document.getElementById(`${id}_weapon`);
            wSel.innerHTML = createWeaponOptions(slot, tier);
            wSel.disabled = false;
        };
        window.onWeaponChange = (id) => {
            const slot = document.getElementById(`${id}_slot`).value;
            const wName = document.getElementById(`${id}_weapon`).value;
            const lSel = document.getElementById(`${id}_level`);
            lSel.innerHTML = createLevelOptions(slot, wName);
            lSel.disabled = false;
            // Select max level by default for UX
            if(lSel.options.length > 1) lSel.selectedIndex = lSel.options.length - 1;
        };

        // Init
        document.addEventListener("DOMContentLoaded", async () => {
            await loadWeaponsJSON();
            addWeapon(); // Add first empty slot
        });

    </script>
</body>
</html>